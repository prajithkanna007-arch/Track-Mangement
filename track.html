<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Track Management System Prototype</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --bg-color: #f0f4f8;
      --card-bg: rgba(255, 255, 255, 0.95);
      --primary-color: #2563eb;
      --secondary-color: #1a4a9c;
      --text-color: #111;
      --danger-color: #ff4d4d;
      --warning-color: #ffd633;
    }
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background: var(--bg-color) url('track.jpg') no-repeat center center fixed;
      background-size: cover;
      color: var(--text-color);
    }
    h1 {
      text-align: center;
      font-size: 2.5rem;
      margin-bottom: 20px;
      color: var(--text-color);
      background: rgba(255, 255, 255, 0.7);
      border-radius: 15px;
      padding: 10px 20px;
      display: inline-block;
      backdrop-filter: blur(5px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    #battery {
      position: fixed;
      top: 15px;
      left: 15px;
      background: var(--card-bg);
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: bold;
      box-shadow: 0 3px 6px rgba(0,0,0,0.2);
      z-index: 1000;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    .card {
      background: var(--card-bg);
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      text-align: center;
      transition: transform 0.2s;
    }
    .card:hover { transform: translateY(-5px); }
    .title { font-size: 1.2rem; font-weight: bold; margin-bottom: 10px; }
    .value { font-size: 1.5rem; font-weight: bold; }
    .status-normal { color: green; }
    .status-fault { color: var(--danger-color); }
    .btn {
      display: inline-block;
      background: var(--primary-color);
      color: #fff;
      padding: 12px 25px;
      margin-top: 20px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 1rem;
      box-shadow: 0 4px 6px rgba(0,0,0,0.2);
      transition: background 0.3s;
    }
    .btn:hover { background: var(--secondary-color); }
    .chart-container {
      width: 100%;
      max-width: 900px;
      margin: 20px auto;
      background: var(--card-bg);
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      text-align: center;
    }
    #map {
      width: 100%;
      height: 350px;
      border-radius: 15px;
      box-shadow: inset 0 0 5px rgba(0,0,0,0.2);
    }
    /* Panels */
    #historyPanel, #accidentPanel {
      position: fixed;
      top: 0;
      right: -400px;
      width: 400px;
      height: 100%;
      background: var(--bg-color);
      box-shadow: -3px 0 10px rgba(0,0,0,0.3);
      transition: right 0.4s ease-in-out;
      overflow-y: auto;
      padding: 20px;
      z-index: 999;
    }
    #historyPanel.active, #accidentPanel.active { right: 0; }
    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .panel-close-btn {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--text-color);
    }
    .history-item {
      background: var(--card-bg);
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 15px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    .history-item h3 {
      margin: 0;
      font-size: 1.1rem;
      color: var(--primary-color);
    }
    .history-item p { margin: 5px 0; font-size: 0.9rem; }
    #historyBtn, #accidentBtn {
      position: fixed;
      right: 20px;
      top: 20px;
      z-index: 1000;
      background: var(--secondary-color);
      color: white;
      padding: 10px 15px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9rem;
      margin-left: 10px;
    }
    #accidentBtn { top: 60px; }
    /* Warning Modal */
    #warningModal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.6);
      z-index: 2000;
      justify-content: center;
      align-items: center;
    }
    #warningModal .content {
      background: white;
      padding: 30px;
      border-radius: 15px;
      text-align: center;
      max-width: 500px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    #warningModal h2 {
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 15px;
      font-size: 1.8rem;
    }
    #warningModal button {
      padding: 12px 25px;
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      transition: background 0.3s;
    }
    #warningModal button:hover { background: var(--secondary-color); }
    .severe { background: var(--danger-color); color: white; }
    .minor { background: var(--warning-color); color: black; }
  </style>
</head>
<body>
  <div id="battery">‚ö° 95%</div>
  <div style="text-align:center;">
    <h1>üöÜ Aurora: Track Wellness</h1>
  </div>

  <div class="grid">
    <div class="card">
      <div class="title">Speed</div>
      <div id="speed" class="value">üöÜ 0 km/h</div>
    </div>
    <div class="card">
      <div class="title">Position</div>
      <div id="position" class="value">üìç Lat: 20.5937, Lon: 78.9629</div>
    </div>
    <div class="card">
      <div class="title">Track Status</div>
      <div id="status" class="value status-normal">Normal</div>
    </div>
    <div class="card">
      <div class="title">Obstacle</div>
      <div id="obstacle" class="value status-normal">None</div>
    </div>
  </div>

  <div style="text-align:center;">
    <button class="btn" onclick="refreshSensors()">üîÑ Refresh Sensors</button>
  </div>

  <div class="chart-container">
    <h2>üöÜ Train Position Map</h2>
    <div id="map"></div>
  </div>
  
  <div class="chart-container">
    <h2>üìà Sensor Data Visualization</h2>
    <canvas id="sensorChart" style="max-height: 250px;"></canvas>
  </div>

  <button id="historyBtn" onclick="toggleHistory()">üìú Data History</button>
  <button id="accidentBtn" onclick="toggleAccident()">üö® Accident History</button>

  <div id="historyPanel">
    <div class="panel-header">
      <h2>Data History</h2>
      <button class="panel-close-btn" onclick="toggleHistory()">‚úñ</button>
    </div>
    <div id="historyList"></div>
  </div>
  <div id="accidentPanel">
    <div class="panel-header">
      <h2>Accident History</h2>
      <button class="panel-close-btn" onclick="toggleAccident()">‚úñ</button>
    </div>
    <div id="accidentList"></div>
  </div>

  <div id="warningModal">
    <div class="content">
      <h2 id="warningHeader">‚ö† Warning!</h2>
      <p id="warningMessage"></p>
      <button onclick="closeWarning()">Acknowledge</button>
    </div>
  </div>

  <script>
    // --- Data Storage ---
    const history = [];
    const accidentHistory = [];
    let pendingAccident = null;
    let prevStatus = "Normal";
    let prevObstacle = "None";

    // --- Chart.js Setup ---
    const chartData = {
      labels: [],
      datasets: [
        {
          label: 'Speed (km/h)',
          data: [],
          borderColor: 'rgb(75, 192, 192)',
          tension: 0.4,
          fill: false,
          yAxisID: 'y'
        },
        {
          label: 'Temperature (¬∞C)',
          data: [],
          borderColor: 'rgb(255, 99, 132)',
          tension: 0.4,
          fill: false,
          yAxisID: 'y1'
        }
      ]
    };

    const chartConfig = {
      type: 'line',
      data: chartData,
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: {
            display: true,
            title: {
              display: true,
              text: 'Time'
            }
          },
          y: {
            type: 'linear',
            display: true,
            position: 'left',
            title: {
              display: true,
              text: 'Speed'
            }
          },
          y1: {
            type: 'linear',
            display: true,
            position: 'right',
            title: {
              display: true,
              text: 'Temperature'
            },
            grid: {
              drawOnChartArea: false,
            }
          }
        }
      }
    };

    const sensorChart = new Chart(
      document.getElementById('sensorChart'),
      chartConfig
    );

    // --- Map Setup ---
    const map = L.map('map').setView([20.5937, 78.9629], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const trainIcon = L.icon({
      iconUrl: 'https://cdn.iconscout.com/icon/free/png-256/free-train-1577457-1335342.png',
      iconSize: [38, 38],
      iconAnchor: [19, 38],
      popupAnchor: [0, -38]
    });
    const trainMarker = L.marker([20.5937, 78.9629], { icon: trainIcon }).addTo(map).bindPopup("üöÜ Train Position (India)");
    
    // --- Sensor Data Generation & Update ---
    function generateSensorData() {
      // Simulate data based on time
      const speed = Math.floor(Math.random() * (120 - 50) + 50);
      const temperature = Math.floor(Math.random() * (60 - (-10)) + (-10));
      const status = speed > 110 || temperature > 55 ? "Fault" : "Normal";
      const obstacleDetected = Math.random() < 0.1;

      // Create snapshot
      const snapshot = {
        time: new Date().toLocaleTimeString(),
        speed,
        positionLat: 20.5937,
        positionLon: 78.9629,
        status,
        temperature,
        obstacle: obstacleDetected ? "Detected" : "None"
      };

      return snapshot;
    }

    function updateDashboard(data) {
      document.getElementById("speed").textContent = `üöÜ ${data.speed} km/h`;
      document.getElementById("position").textContent = `üìç Lat: ${data.positionLat.toFixed(4)}, Lon: ${data.positionLon.toFixed(4)}`;

      const statusElement = document.getElementById("status");
      statusElement.textContent = data.status;
      statusElement.className = `value status-${data.status === "Normal" ? "normal" : "fault"}`;

      const obstacleElement = document.getElementById("obstacle");
      obstacleElement.textContent = data.obstacle;
      obstacleElement.className = `value status-${data.obstacle === "None" ? "normal" : "fault"}`;
    }

    function updateMap(data) {
      trainMarker.setLatLng([data.positionLat, data.positionLon])
        .setPopupContent(`üöÜ Train: ${data.time}`);
    }

    function updateCharts(data) {
      const maxDataPoints = 15;
      chartData.labels.push(data.time);
      chartData.datasets[0].data.push(data.speed);
      chartData.datasets[1].data.push(data.temperature);

      if (chartData.labels.length > maxDataPoints) {
        chartData.labels.shift();
        chartData.datasets[0].data.shift();
        chartData.datasets[1].data.shift();
      }

      sensorChart.update();
    }

    function checkErrors(data) {
      // Check for high/low temperature
      if (data.temperature > 55) {
        showWarning(`üî• High Heat Stress: ${data.temperature}¬∞C. Risk of rail buckling!`, "severe");
      } else if (data.temperature < -10) {
        showWarning(`‚ùÑÔ∏è Cold Contraction: ${data.temperature}¬∞C. Risk of rail fracture!`, "severe");
      }
      // Check for track status change
      if (data.status !== prevStatus && data.status === "Fault") {
        showWarning(`‚ö†Ô∏è Track Status:'Fault'. Investigate immediately.`, "severe");
      }
      // Check for new obstacle
      if (data.obstacle !== prevObstacle && data.obstacle === "Detected") {
        showWarning('üöß Obstacle detected on track!', "severe");
      }

      // Update previous states
      prevStatus = data.status;
      prevObstacle = data.obstacle;
    }

    // --- Main Update Loop ---
    function performUpdate() {
      const data = generateSensorData();
      if (!data) return; // In case of a paused state

      history.push(data);
      updateDashboard(data);
      updateMap(data);
      updateCharts(data);
      updateHistoryPanel();
      checkErrors(data);
    }
    
    // Initial run
    performUpdate();
    // Start auto-updates
    setInterval(performUpdate, 5000);
    
    // --- UI/Panel Management ---
    function refreshSensors() {
      alert("Manually refreshing system sensors...");
      performUpdate();
    }

    function updateHistoryPanel() {
      const historyList = document.getElementById("historyList");
      historyList.innerHTML = "";
      history.slice().reverse().forEach((item) => {
        const div = document.createElement("div");
        div.className = "history-item";
        div.innerHTML = `
          <h3>Snapshot at ${item.time}</h3>
          <p>Speed: ${item.speed} km/h</p>
          <p>Status: <span class="status-${item.status === 'Normal' ? 'normal' : 'fault'}">${item.status}</span></p>
          <p>Obstacle: <span class="status-${item.obstacle === 'None' ? 'normal' : 'fault'}">${item.obstacle}</span></p>
          <p>Temperature: ${item.temperature} ¬∞C</p>
        `;
        historyList.appendChild(div);
      });
    }

    function updateAccidentPanel() {
      const accidentList = document.getElementById("accidentList");
      accidentList.innerHTML = "";
      accidentHistory.slice().reverse().forEach((msg) => {
        const div = document.createElement("div");
        div.className = "history-item";
        div.innerHTML = `
          <h3>Accident at ${msg.time}</h3>
          <p>Severity: <strong class="${msg.severity}">${msg.severity.toUpperCase()}</strong></p>
          <p>Disturbance: ${msg.text}</p>
        `;
        accidentList.appendChild(div);
      });
    }

    function toggleHistory() {
      document.getElementById("historyPanel").classList.toggle("active");
    }

    function toggleAccident() {
      document.getElementById("accidentPanel").classList.toggle("active");
    }

    function showWarning(msg, severity = "severe") {
      document.getElementById("warningMessage").textContent = msg;

      const header = document.getElementById("warningHeader");
      header.className = severity === "severe" ? "severe" : "minor";
      header.textContent = `‚ö† ${severity === "severe" ? "Severe Threat" : "Minor Threat"}`;

      document.getElementById("warningModal").style.display = "flex";

      pendingAccident = { time: new Date().toLocaleTimeString(), text: msg, severity: severity };
    }

    function closeWarning() {
      document.getElementById("warningModal").style.display = "none";
      if (pendingAccident) {
        accidentHistory.push(pendingAccident);
        updateAccidentPanel();
        pendingAccident = null;
      }
    }
  </script>
</body>
</html>